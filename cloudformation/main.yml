Resources:
  #
  # IAM
  #
  GitHubOIDC:
    Type: AWS::IAM::OIDCProvider
    Properties:
      Url: https://token.actions.githubusercontent.com
      ThumbprintList:
        - 6938fd4d98bab03faadb97b34396831e3780aea1
      ClientIdList:
        - sts.amazonaws.com

  CloudformationDeploymentRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: github-oidc-role
      MaxSessionDuration: 3600
      Policies:
        - PolicyName: inline
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - sts:AssumeRoleWithWebIdentity
                  - cloudformation:*
                Resource:
                  - "*"
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Action: sts:AssumeRoleWithWebIdentity
            Principal:
              Federated: !Ref GitHubOIDC
            Condition:
              StringLike:
                token.actions.githubusercontent.com:sub: repo:Beta-Folf/stash-bot:ref:refs/heads/main

  ECRUser:
    Type: AWS::IAM::User
    Properties:
      UserName: stash-bot-ecr

  #
  # Networking
  #
  StashBotVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: "172.31.0.0/16"
      EnableDnsSupport: "true"
      EnableDnsHostnames: "true"

  EC2Subnet:
    Type: AWS::EC2::Subnet
    Properties:
      CidrBlock: !GetAtt StashBotVPC.CidrBlock
      AvailabilityZone: "us-east-1a"
      VpcId:
        Ref: StashBotVPC

  #
  # s3
  #
  CodePipelineArtifacts:
    Type: AWS::S3::Bucket
    Properties:
      AccessControl: Private
      BucketName: stash-bot-code-pipeline-artifacts

  #
  # EC2
  #
  EC2SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: stash-bot-ec2-sg
      GroupDescription: The security group for the stash bot EC2 instances
      VpcId:
        Ref: StashBotVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0

  EC2LaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateName: stash-bot-ec2-launch-template
      LaunchTemplateData:
        ImageId: ami-08e4e35cccc6189f4 # Amazon linux x86
        InstanceType: t2.micro
        SecurityGroupIds:
          - !Ref EC2SecurityGroup

  AutoScalingGroup:
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      AutoScalingGroupName: stash-bot-asg
      MinSize: "1"
      MaxSize: "1"
      LaunchTemplate:
        LaunchTemplateId: !Ref EC2LaunchTemplate
        Version: !GetAtt EC2LaunchTemplate.LatestVersionNumber
      AvailabilityZones:
        - "us-east-1a"
      VPCZoneIdentifier:
        - !Ref EC2Subnet

  #
  # ECR
  #
  ECRRepository:
    Type: AWS::ECR::Repository
    Properties:
      RepositoryName: stash-bot-ecr-repository
      RepositoryPolicyText:
        Version: "2012-10-17"
        Statement:
          - Sid: AllowPushPull
            Effect: Allow
            Principal:
              AWS: !GetAtt ECRUser.Arn
            Action:
              - "ecr:GetDownloadUrlForLayer"
              - "ecr:BatchGetImage"
              - "ecr:BatchCheckLayerAvailability"
              - "ecr:PutImage"
              - "ecr:InitiateLayerUpload"
              - "ecr:UploadLayerPart"
              - "ecr:CompleteLayerUpload"
